# ุชูุฑูุฑ ุชุทุจูู ุงูุจููุฉ ุงููุญูุฑูุฉ ููุดุญูุงุช - ููุฎุต ุชูููุฐู
## Shipment-Centric Architecture Implementation - Executive Summary

**ุงูุชุงุฑูุฎ:** 24 ุฏูุณูุจุฑ 2024  
**Migration:** 129_shipment_centric_architecture.sql  
**ุงูุญุงูุฉ:** โ ููุทุจูู ุจูุฌุงุญ

---

## โ ุชู ุชูููุฐ ุฌููุน ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ

### 1. ุงูุดุญูุฉ = ุงูููุงู ุงููุญูุฑู โ

ุชู ุชุนุฏูู ุฌุฏูู `logistics_shipments` ููููู ุงูููุงู ุงููุญูุฑู ูู ุงููุธุงู:

```sql
ALTER TABLE logistics_shipments 
ADD COLUMN project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE RESTRICT,
ADD COLUMN purchase_order_id INTEGER REFERENCES purchase_orders(id),
ADD COLUMN vendor_id INTEGER REFERENCES vendors(id);
```

**ุงููุชูุฌุฉ:**
- โ ูู ุดุญูุฉ ูุฌุจ ุฃู ุชุฑุชุจุท ุจูุดุฑูุน (project_id ุฅุฌุจุงุฑู)
- โ ุฑุจุท ุงุฎุชูุงุฑู ุจุฃูุฑ ุงูุดุฑุงุก (purchase_order_id)
- โ ุฑุจุท ุจุงูููุฑุฏ (vendor_id)
- โ ูุง ูููู ุญุฐู ุงููุดุฑูุน ุฅุฐุง ูุงูุช ูู ุดุญูุงุช ูุดุทุฉ

---

### 2. ุจููุฏ ูุตุงุฑูู ุงูุดุญูุงุช ุงูู 17 โ

ุชู ุฅูุดุงุก ุฌุฏูู `shipment_expense_types` ูุชุนุจุฆุชู ุจุฌููุน ุงูู 17 ุจูุฏ ูุตุฑูู ูู ุงูุตูุฑุฉ ุงููุฑููุฉ:

| ุงูููุฏ | ุงูุงุณู ุจุงูุนุฑุจู | ุฑูู ุงูุญุณุงุจ |
|------|--------------|------------|
| EXP_001 | ูุตุงุฑูู ุงุนุชูุงุฏ ุดุญูุฉ ุนุงูุฉ / ุนูููุฉ ูููู / ุชุฃููู / ูุตุงุฑูู ุฃุฎุฑู | 11510100003-8001 |
| EXP_002 | ุงูุชุฃููู ุงูุจุญุฑู / ุงูุชุฃููู ุงูุจุฑู | 11510100003-8002 |
| EXP_003 | ุฃุฌูุฑ ุชูุฑูุบ ุงูุจุถุงุนุฉ | 11510100003-8003 |
| EXP_004 | ุฃุฌูุฑ ุชุณููู ููุฑู | 11510100003-8004 |
| EXP_005 | ุฃุฌูุฑ ุจูุงู ุฌูุฑูู | 11510100003-8005 |
| EXP_006 | ุฃุฌูุฑ ุงูุฅูุตุงูุงุช | 11510100003-8006 |
| EXP_007 | ุฃุฌูุฑ ุงูุชุฎููุต | 11510100003-8007 |
| EXP_008 | ุฃุฌูุฑ ุงูุฏูุบุฉ | 11510100003-8008 |
| EXP_009 | ุฃุฌูุฑ ุงููุญุงุณุจุฉ ุงูุฌูุฑููุฉ | 11510100003-8009 |
| EXP_010 | ุฃุฌูุฑ ุชุฃุฎูุฑ ุงุณุชูุงู ุงูุญุงููุงุช | 11510100003-8010 |
| EXP_011 | ุฃุฌูุฑ ุงูุชุฎููุต ุงูุฌูุฑูู | 11510100003-8011 |
| EXP_012 | ุฃุฌูุฑ ููู | 11510100003-8012 |
| EXP_013 | ุฃุฌูุฑ ุงูุชุญููู ูุงูุชูุฑูุบ | 11510100003-8013 |
| EXP_014 | ุฃุฌูุฑ ูุญุต ุงูุจุถุงุนุฉ | 11510100003-8014 |
| EXP_015 | ุฃุฌูุฑ ุดูุงุฏุฉ ุงูุงุณุชูุฑุงุฏ / ุงูุดูุงุฏุงุช ุงููุทููุจุฉ | 11510100003-8015 |
| EXP_016 | ุฃุฌูุฑ ุชุฃุฎูุฑ ุชูุฑูุบ ุงูุดุญูุฉ | 11510100003-8016 |
| EXP_017 | ุงูุฅูุฌุงุฑ / ุงูุชุฎุฒูู / ุฑุณูู ุงููุธุงูุฉ | 11510100003-8017 |

**ุงูุชุญูู:**
```sql
SELECT COUNT(*) FROM shipment_expense_types;
-- ุงููุชูุฌุฉ: 17 โ
```

---

### 3. ุงูุฑุจุท ุจุดุฌุฑุฉ ุงูุญุณุงุจุงุช โ

ูู ููุน ูุตุฑูู ูุฑุชุจุท ุจุญุณุงุจ ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช:

```sql
CREATE TABLE shipment_expense_types (
  ...
  default_account_id INTEGER REFERENCES accounts(id),
  account_number VARCHAR(50),  -- ูู ุงูุตูุฑุฉ: 11510100003-8001
  ...
);
```

**ุงููููุฒุงุช:**
- โ ูู ูุตุฑูู ูู ุญุณุงุจ ุงูุชุฑุงุถู
- โ ุฑูู ุงูุญุณุงุจ ููุฌูุฏ ุจุงูุถุจุท ููุง ูู ุงูุตูุฑุฉ
- โ ูุงุจู ููุชุนุฏูู ูุงูุฅุถุงูุฉ ูู ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ

---

### 4. ุงูุชูุฒูุน ุงูุชููุงุฆู ูููุตุงุฑูู โ

ุชู ุฅูุดุงุก ูุธุงู ุชูุฒูุน ุชููุงุฆู ููุฒุน ุงููุตุฑูู ุนูู ุฃุตูุงู ุงูุดุญูุฉ ุจู 4 ุทุฑู:

| ุงูุทุฑููุฉ | ุงูุฃุณุงุณ | ูุซุงู |
|---------|--------|------|
| **WEIGHT** | ุงููุฒู ุงูุฅุฌูุงูู | ุตูู ูุฒูู 100 ูุฌู ูู 1000 ูุฌู = 10% ูู ุงููุตุฑูู |
| **QTY** | ุงููููุฉ ุงูุฅุฌูุงููุฉ | ุตูู ูููุชู 50 ูู 500 = 10% ูู ุงููุตุฑูู |
| **VALUE** | ุงููููุฉ ุงูุฅุฌูุงููุฉ | ุตูู ูููุชู 5,000 ูู 50,000 = 10% ูู ุงููุตุฑูู |
| **EQUAL** | ุชูุฒูุน ูุชุณุงูู | 5 ุฃุตูุงู = ูู ุตูู 20% ูู ุงููุตุฑูู |

**ุงูุชุทุจูู:**
```sql
-- ุฅูุดุงุก ุงูุฏุงูุฉ
CREATE FUNCTION distribute_shipment_expense(p_expense_id INTEGER)

-- ุฅูุดุงุก Triggers ุชููุงุฆูุฉ
CREATE TRIGGER trg_after_shipment_expense_insert
AFTER INSERT ON shipment_expenses
FOR EACH ROW EXECUTE FUNCTION trigger_distribute_shipment_expense();

CREATE TRIGGER trg_after_shipment_expense_update
AFTER UPDATE ON shipment_expenses
FOR EACH ROW EXECUTE FUNCTION trigger_distribute_shipment_expense();
```

**ุงููุชูุฌุฉ:**
- โ ุงูุชูุฒูุน ูุญุฏุซ ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ/ุชุนุฏูู ุงููุตุฑูู
- โ ูุง ูุญุชุงุฌ ุงููุณุชุฎุฏู ูุญุณุงุจ ุงููุณุจ ูุฏููุงู
- โ ููุณุฌู ูู ุฌุฏูู `shipment_expense_distributions`

---

### 5. ุฏุนู ูุชุนุฏุฏ ุงูุนููุงุช โ

ุฌุฏูู `shipment_expenses` ูุฏุนู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ:

```sql
CREATE TABLE shipment_expenses (
  ...
  amount NUMERIC(18, 4) NOT NULL,           -- ุงููุจูุบ ุจุงูุนููุฉ ุงูุฃุตููุฉ
  currency_id INTEGER NOT NULL,             -- ุงูุนููุฉ
  exchange_rate NUMERIC(18, 6) DEFAULT 1,   -- ุณุนุฑ ุงูุตุฑู
  amount_local GENERATED ALWAYS AS (amount * exchange_rate) STORED,  -- ุงููุจูุบ ุจุงูุนููุฉ ุงููุญููุฉ
  ...
);
```

**ุงููููุฒุงุช:**
- โ ุฅุฏุฎุงู ุงููุจูุบ ุจุฃู ุนููุฉ
- โ ุญุณุงุจ ุชููุงุฆู ูููุจูุบ ุจุงูุนููุฉ ุงููุญููุฉ
- โ ุชุฎุฒูู ุณุนุฑ ุงูุตุฑู ูุญุธุฉ ุงูุฅุฏุฎุงู

---

### 6. ุงููููุฏ ุงูุตุงุฑูุฉ โ

ุชู ุชุทุจูู 3 ูููุฏ ุฃุณุงุณูุฉ:

#### ุฃ) ููุน ุญุฐู ุงููุดุฑูุน ุงููุฑุชุจุท ุจุดุญูุฉ

```sql
CREATE FUNCTION prevent_project_deletion()
CREATE TRIGGER trg_before_project_delete
```

**ุงููุชูุฌุฉ:**
```sql
DELETE FROM projects WHERE id = 1;
-- ERROR: Cannot delete project: linked to active shipments โ
```

#### ุจ) ููุน ุชุนุฏูู ุงูุดุญูุฉ ุงูููููุฉ

```sql
CREATE FUNCTION prevent_locked_shipment_edit()
CREATE TRIGGER trg_before_shipment_update
```

**ุงููุชูุฌุฉ:**
```sql
UPDATE logistics_shipments SET stage_code = 'ARRIVED' WHERE locked_at IS NOT NULL;
-- ERROR: Cannot modify locked shipment โ
```

#### ุฌ) ููุน ุชุนุฏูู ุงููุตุฑูู ุจุนุฏ ุงูุชุฑุญูู

```sql
CREATE FUNCTION prevent_posted_expense_edit()
CREATE TRIGGER trg_before_expense_update
```

**ุงููุชูุฌุฉ:**
```sql
UPDATE shipment_expenses SET amount = 9999 WHERE posted = true;
-- ERROR: Cannot modify posted expense โ
```

---

### 7. ุงูุชูุฑูุฑ ุงูุดุงูู โ

ุชู ุฅูุดุงุก View ุดุงูู `vw_inbound_shipment_report` ูุฌูุน ูู ุงูุจูุงูุงุช:

```sql
CREATE VIEW vw_inbound_shipment_report AS
SELECT 
  -- ูุนูููุงุช ุงูุดุญูุฉ (10 ุฃุนูุฏุฉ)
  shipment_id, shipment_number, bl_no, awb_no, incoterm, stage_code, status_code, ...
  
  -- ูุนูููุงุช ุงููุดุฑูุน (4 ุฃุนูุฏุฉ) - ุฅุฌุจุงุฑู!
  project_id, project_code, project_name, project_name_ar,
  
  -- ูุนูููุงุช ุฃูุฑ ุงูุดุฑุงุก (3 ุฃุนูุฏุฉ)
  purchase_order_id, po_number, po_date,
  
  -- ูุนูููุงุช ุงูููุฑุฏ (4 ุฃุนูุฏุฉ)
  vendor_id, vendor_code, vendor_name, vendor_name_ar,
  
  -- ุงููููุน (2 ุนููุฏุงู)
  origin_location, destination_location,
  
  -- ุฅุญุตุงุฆูุงุช ุงูุฃุตูุงู (3 ุฃุนูุฏุฉ)
  items_count, total_quantity, items_total_value,
  
  -- ุฅุญุตุงุฆูุงุช ุงููุตุงุฑูู (3 ุฃุนูุฏุฉ)
  total_expenses, posted_expenses, pending_expenses,
  
  -- ุงููุฏููุนุงุช (1 ุนููุฏ)
  total_payments,
  
  -- ุงูุชูููุฉ ุงูููุงุฆูุฉ (1 ุนููุฏ)
  final_cost
  
FROM logistics_shipments ls
LEFT JOIN projects p ON p.id = ls.project_id
LEFT JOIN purchase_orders po ON po.id = ls.purchase_order_id
LEFT JOIN vendors v ON v.id = ls.vendor_id
...
```

**ุงูุงุณุชุฎุฏุงู:**
```sql
SELECT * FROM vw_inbound_shipment_report WHERE project_id = 50;
```

**ุงููุชูุฌุฉ:**
- โ ุชูุฑูุฑ ูุงุญุฏ ูุนุฑุถ ูู ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุจุงูุดุญูุฉ
- โ ุฅุญุตุงุฆูุงุช ูุญุณูุจุฉ ุชููุงุฆูุงู
- โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุงูุชูุงุฑูุฑ ูุงูู dashboards

---

### 8. ุงูุตูุงุญูุงุช ุงูุฌุฏูุฏุฉ โ

ุชู ุฅุถุงูุฉ 7 ุตูุงุญูุงุช ููุชุญูู ูู ูุตุงุฑูู ุงูุดุญูุงุช:

| ุงูููุฏ | ุงููุตู |
|------|------|
| `shipments:expenses:view` | ุนุฑุถ ูุตุงุฑูู ุงูุดุญูุงุช |
| `shipments:expenses:create` | ุฅูุดุงุก ูุตุงุฑูู ุงูุดุญูุงุช |
| `shipments:expenses:update` | ุชุนุฏูู ูุตุงุฑูู ุงูุดุญูุงุช |
| `shipments:expenses:delete` | ุญุฐู ูุตุงุฑูู ุงูุดุญูุงุช |
| `shipments:expenses:approve` | ุงุนุชูุงุฏ ูุตุงุฑูู ุงูุดุญูุงุช |
| `shipments:expenses:post` | ุชุฑุญูู ูุตุงุฑูู ุงูุดุญูุงุช ูููุญุงุณุจุฉ |
| `shipments:lock` | ููู ุงูุดุญูุงุช |

**ุงูุชุญูู:**
```sql
SELECT COUNT(*) FROM permissions WHERE permission_code LIKE 'shipments:%';
-- ุงููุชูุฌุฉ: 7 โ
```

---

## ๐ฏ ุณูุฑ ุงูุนูู ุงููุงูู

```
1. ุฅูุดุงุก ุงููุดุฑูุน
   โ
2. ุฅูุดุงุก ุฃูุฑ ุงูุดุฑุงุก (ูุญูู project_id ู vendor_id)
   โ
3. ุฅูุดุงุก ุงูุดุญูุฉ (ุฅุฌุจุงุฑู: project_id)
   โ
4. ุฅุถุงูุฉ ุฃุตูุงู ุงูุดุญูุฉ
   โ
5. ุฅุถุงูุฉ ูุตุงุฑูู ุงูุดุญูุฉ (ูุฎุชุงุฑ ููุน ูู ุงูู 17)
   โ (ุชููุงุฆูุงู)
6. ุชูุฒูุน ุงููุตุฑูู ุนูู ุงูุฃุตูุงู (ุญุณุจ ุงูุทุฑููุฉ ุงููุฎุชุงุฑุฉ)
   โ
7. ุงุนุชูุงุฏ ุงููุตุฑูู
   โ
8. ุชุฑุญูู ุงููุตุฑูู (ุฅูุดุงุก ููุฏ ูุญุงุณุจู)
   โ
9. ููู ุงูุดุญูุฉ (ููุน ุฃู ุชุนุฏูู)
   โ
10. ุงูุชูุฑูุฑ ุงูุดุงูู (vw_inbound_shipment_report)
```

---

## ๐ ูุซุงู ุนููู

### ุฅูุดุงุก ูุตุฑูู ุฌูุฑูู ูุชูุฒูุนู

```sql
-- 1. ุฅูุดุงุก ูุตุฑูู (ุฑุณูู ุจูุงู ุฌูุฑูู)
INSERT INTO shipment_expenses (
  company_id, shipment_id, project_id, expense_type_id,
  amount, currency_id, distribution_method,
  reference_number, description, created_by
) VALUES (
  1,              -- company_id
  101,            -- shipment_id
  50,             -- project_id (ุฅุฌุจุงุฑู!)
  5,              -- expense_type_id (EXP_005 - ุฑุณูู ุจูุงู ุฌูุฑูู)
  2500.00,        -- amount
  1,              -- currency_id (SAR)
  'VALUE',        -- distribution_method (ุชูุฒูุน ุญุณุจ ุงููููุฉ)
  'CUST-2024-001',
  'ุฑุณูู ุจูุงู ุฌูุฑูู ููุดุญูุฉ SHP-2024-101',
  1
);

-- โ ุงูุชูุฒูุน ูุญุฏุซ ุชููุงุฆูุงู!

-- 2. ุนุฑุถ ุงูุชูุฒูุน
SELECT 
  lsi.item_code,
  (lsi.quantity * lsi.unit_cost) as item_value,
  sed.distribution_percentage,
  sed.allocated_amount
FROM shipment_expense_distributions sed
JOIN logistics_shipment_items lsi ON lsi.id = sed.shipment_item_id
WHERE sed.expense_id = [id_ูู_ุงูุฎุทูุฉ_ุงูุณุงุจูุฉ];

-- ุงููุชูุฌุฉ ุงููุชููุนุฉ:
-- item_code | item_value | percentage | allocated_amount
-- ITEM-001  |  50,000    |    50%     |    1,250.00
-- ITEM-002  |  30,000    |    30%     |      750.00
-- ITEM-003  |  20,000    |    20%     |      500.00
-- TOTAL     | 100,000    |   100%     |    2,500.00

-- 3. ุงุนุชูุงุฏ ุงููุตุฑูู
UPDATE shipment_expenses 
SET approval_status = 'approved', approved_by = 2, approved_at = NOW()
WHERE id = [id];

-- 4. ุชุฑุญูู ุงููุตุฑูู
UPDATE shipment_expenses 
SET posted = true, posted_by = 2, posted_at = NOW()
WHERE id = [id];

-- โ ุจุนุฏ ุงูุชุฑุญูู:
-- - ุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู
-- - ูุง ูููู ุชุนุฏูู ุงููุตุฑูู ููุงุฆูุงู
```

---

## ๐ ุงูุฎุทูุงุช ุงููุงุฏูุฉ

### ุฃููููุฉ 1: Backend API (ุชุญุชุงุฌ ุชุทููุฑ)

- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฌุงูุฒุฉ
- ๐ Backend Routes (ุชุญุชุงุฌ ุฅูุดุงุก):
  - `GET /api/shipments/:id/expenses` - ูุงุฆูุฉ ุงููุตุงุฑูู
  - `POST /api/shipments/:id/expenses` - ุฅูุดุงุก ูุตุฑูู
  - `PUT /api/shipments/:id/expenses/:id` - ุชุนุฏูู ูุตุฑูู
  - `DELETE /api/shipments/:id/expenses/:id` - ุญุฐู ูุตุฑูู
  - `POST /api/shipments/:id/expenses/:id/approve` - ุงุนุชูุงุฏ ูุตุฑูู
  - `POST /api/shipments/:id/expenses/:id/post` - ุชุฑุญูู ูุตุฑูู
  - `GET /api/shipments/:id/expenses/:id/distribution` - ุนุฑุถ ุงูุชูุฒูุน
  - `GET /api/master/shipment-expense-types` - ูุงุฆูุฉ ุฃููุงุน ุงููุตุงุฑูู

### ุฃููููุฉ 2: Frontend UI (ุชุญุชุงุฌ ุชุทููุฑ)

- ๐ `ShipmentExpensesTab.tsx` - ุชุจููุจ ุงููุตุงุฑูู ูู ุตูุญุฉ ุงูุดุญูุฉ
- ๐ `AddExpenseModal.tsx` - ูุงูุฐุฉ ุฅุถุงูุฉ ูุตุฑูู
- ๐ `ViewDistributionModal.tsx` - ูุงูุฐุฉ ุนุฑุถ ุงูุชูุฒูุน
- ๐ `InboundShipmentReport.tsx` - ุตูุญุฉ ุงูุชูุฑูุฑ ุงูุดุงูู

### ุฃููููุฉ 3: Integration

- ๐ ุฑุจุท `vendor_payments` ุจุงูุดุญูุฉ (ุฅุถุงูุฉ `shipment_id`)
- ๐ ุฑุจุท ุงูุชุฑุญูู ุจุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ (`journal_entries`)
- ๐ ุชุญุฏูุซ `vw_inbound_shipment_report` ูุชุดูู ุงููุฏููุนุงุช

---

## โ ุงูููุฎุต

### ุชู ุชูููุฐ ุงูููุณูุฉ ุงูุฃุณุงุณูุฉ ุจูุฌุงุญ:

| ุงููุชุทูุจ | ุงูุญุงูุฉ |
|---------|-------|
| โ ุงูุดุญูุฉ = ุงูููุงู ุงููุญูุฑู | ููุทุจูู |
| โ project_id ุฅุฌุจุงุฑู ููู ุดุญูุฉ | ููุทุจูู |
| โ ุฑุจุท ุจุฃูุฑ ุงูุดุฑุงุก ูุงูููุฑุฏ | ููุทุจูู |
| โ 17 ููุน ูุตุฑูู ูุฑุชุจุทุฉ ุจุดุฌุฑุฉ ุงูุญุณุงุจุงุช | ููุทุจูู |
| โ ุงูุชูุฒูุน ุงูุชููุงุฆู ุจู 4 ุทุฑู | ููุทุจูู |
| โ ุฏุนู ูุชุนุฏุฏ ุงูุนููุงุช | ููุทุจูู |
| โ ุงููููุฏ ุงูุตุงุฑูุฉ | ููุทุจูู |
| โ ุงูุชูุฑูุฑ ุงูุดุงูู | ููุทุจูู |
| โ ุงูุตูุงุญูุงุช | ููุทุจูู |
| ๐ Backend API | ุชุญุช ุงูุชุทููุฑ |
| ๐ Frontend UI | ุชุญุช ุงูุชุทููุฑ |

---

**ุงูุฎูุงุตุฉ:** ุชู ุชุทุจูู ุฌููุน ูุชุทูุจุงุช ุงูุจููุฉ ุงููุนูุงุฑูุฉ ุงููุญูุฑูุฉ ููุดุญูุงุช ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ. ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ุชุทููุฑ ุงูู Backend API ูุงููุงุฌูุงุช ุงูุฃูุงููุฉ ูุงุณุชุฎุฏุงู ูุฐู ุงูุจููุฉ.

---

**ุชุงุฑูุฎ ุงูุชูุฑูุฑ:** 24 ุฏูุณูุจุฑ 2024  
**ุงูุฅุตุฏุงุฑ:** 1.0
